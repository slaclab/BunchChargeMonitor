#This database contains the PV's nessecary to set the Bergoz 
#system into calibration mode and reset to normal opertation

#trigger 0 state backup
#record(bi, "$(P):TRIG1BACKUP"){
#    field(DESC, "Save of trig 1")
#    field(ZNAM, "Disabled")
#    field(ONAM, "Enabled")
#    field(INP, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG00_SYS2_TCTL")
#}

#should figure out how to get the trigger source then pull that pv
record(calcout, "$(P):SETTRIG6SRC"){
    field(CALC, "6")
    field(OUT, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SOURCE")
    field(FLNK, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SOURCE")
    field(SCAN, "1 second")
}

record(mbbi, "$(P):TRIG6RATEBACKUP"){
    field(INP, "TPR:$(LOCA):$(IOC_UNIT):$(INST):CH06_FIXEDRATE")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(ZRST, "1MHz")
    field(ONST, "71.5kHz")
    field(TWST, "10kHz")
    field(THST, "1kHz")
    field(FRST, "100Hz")
    field(FVST, "10Hz")
    field(SXST, "1Hz")
}

#calc if in calib mode
record(calc, "$(P):CalibCalcRBV"){
    field(DESC, "Check if in calibration mode")
    field(SCAN, "1 second")
    field(INPA, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG00_SYS2_TCTL") 
    field(INPB, "TPR:$(LOCA):$(IOC_UNIT):$(INST):CH06_FIXEDRATE")
    field(INPE, "$(P):TLR5:SelSrcRBV")
    field(INPF, "$(P):TLR7:SelSrcRBV")
    field(INPG, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SYS2_TWID")
    field(INPH, "$(P):SWITCHES_WR")
    field(CALC, "(A=0)&&(B=0)&&(E=2)&&(F=2)&&(G=200)&&(H=7) ? 1 : 0")
}

#calc if in normal operation 
record(calc, "$(P):RunningCalcRBV"){
    field(DESC, "Check if operational mode")
    field(SCAN, "1 second")
    field(INPE, "$(P):TLR5:SelSrcRBV")
    field(INPF, "$(P):TLR7:SelSrcRBV")
    field(INPG, "$(P):SWITCHES_WR")
    field(CALC, "((E=1)&&(F=1)&&(G=6)) ? 1 : 0")
}

#calc to see if the device is in calibration mode normal mode or broken
record(calc, "$(P):BergozModeCalcRBV"){
    field(DESC, "IOC bergoz mode")
    field(SCAN, "1 second")
    field(INPA, "$(P):RunningCalcRBV") 
    field(INPB, "$(P):CalibCalcRBV")
    field(CALC, "A ? 0 : B ? 1 : 2")
}

#MBBI to give name if in calib mode
record(mbbi, "$(P):BergozModeRBV"){
    field(DESC, "Device Mode")
    field(SCAN, "1 second")
    field(ZRST, "Running")
    field(ONST, "Calibration")
    field(TWST, "Broken")
    field(INP, "$(P):BergozModeCalcRBV")
}


#set to move into calibration mode
record(mbbi, "$(P):BergozMode"){
    field(DESC, "Sets the IOC Bergoz mode")
    field(ZRST, "Running")
    field(ONST, "Calibration")
    field(PINI, "YES")
    field(FLNK, "$(P):SetBergozMode")
}

record(fanout, "$(P):SetBergozMode"){
    field(DESC, "Internal")
    field(SCAN, "Passive")
    field(LNK0, "$(P):SetTrig0")
    field(LNK1, "$(P):SaveChan6Rate")
    field(LNK2, "$(P):SetTLR5SelSrc")
    field(LNK3, "$(P):SetTLR7SelSrc")
    field(LNK4, "$(P):SetCalibEnable")
    field(LNK5, "$(P):SetSWITCHES_WR")
    field(LNK6, "$(P):SaveTrig6TWID")
    field(LNK7, "$(P):SaveTrig6DEST")
}

record(calcout, "$(P):SetTrig0"){
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(CALC, "!A ? 1 : 0")
    field(OUT, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG00_SYS2_TCTL")
    field(FLNK, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG00_SYS2_TCTL")
}

#save chan/trig 6 rate
record(calcout, "$(P):SaveChan6Rate"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "TPR:$(LOCA):$(IOC_UNIT):$(INST):CH06_FIXEDRATE")
    field(INPC, "$(P):SaveChan6Rate")
    field(CALC, "!A ? C : B")
    field(FLNK, "$(P):SetChan6Rate")
}

record(calcout, "$(P):SetChan6Rate"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "$(P):SaveChan6Rate")
    field(CALC, "!A ? B : 0")
    field(OUT, "TPR:$(LOCA):$(IOC_UNIT):$(INST):CH06_FIXEDRATE")
    field(FLNK, "TPR:$(LOCA):$(IOC_UNIT):$(INST):CH06_FIXEDRATE")
}

#save trig 6 width
record(calcout, "$(P):SaveTrig6TWID"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SYS2_TWID")
    field(INPC, "$(P):SaveTrig6TWID")
    field(CALC, "!A ? C : B")
    field(FLNK, "$(P):SetTrig6TWID")
}

#set trigger 6 width
record(calcout, "$(P):SetTrig6TWID"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "$(P):SaveTrig6TWID")
    field(CALC, "!A ? B : 200")
    field(OUT, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SYS2_TWID")
    field(FLNK, "TPR:$(LOCA):$(IOC_UNIT):$(INST):TRG06_SYS2_TWID")
}

#save trig 6 dest
record(calcout, "$(P):SaveTrig6DEST"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "TPR:${LOCA}:${IOC_UNIT}:${INST}:CH06_DESTMODE")
    field(INPC, "$(P):SaveTrig6DEST")
    field(CALC, "!A ? C : B")
    field(FLNK, "$(P):SetTrig6DEST")
}

#set trigger 6 dest
record(calcout, "$(P):SetTrig6DEST"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(INPB, "$(P):SaveTrig6DEST")
    field(CALC, "!A ? B : 2")
    field(OUT,  "TPR:${LOCA}:${IOC_UNIT}:${INST}:CH06_DESTMODE")
    field(FLNK, "TPR:${LOCA}:${IOC_UNIT}:${INST}:CH06_DESTMODE")
}

record(calcout, "$(P):SetSWITCHES_WR"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(CALC, "!A ? 6 : 7")
    field(OUT, "$(P):SWITCHES_WR")
    field(FLNK, "$(P):SWITCHES_WR")
}

record(calcout, "$(P):SetTLR5SelSrc"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(CALC, "!A ? 1 : 2")
    field(OUT, "$(P):TLR5:SelSrc")
    field(FLNK, "$(P):TLR5:SelSrc")    
}

record(calcout, "$(P):SetTLR7SelSrc"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(CALC, "!A ? 1 : 2")
    field(OUT, "$(P):TLR7:SelSrc")
    field(FLNK, "$(P):TLR7:SelSrc")    
}

record(calcout, "$(P):SetCalibEnable"){
    field(DESC, "")
    field(SCAN, "Passive")
    field(INPA, "$(P):BergozMode") 
    field(CALC, "!A ? 0 : 1")
    field(OUT, "$(AmcPrefix):CalibEnable")
    field(FLNK, "$(AmcPrefix):CalibEnable") 

}







